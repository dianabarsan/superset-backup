name: 'superset-backup'
description: 'Download and save Superset dashboard export in a GH repository'
inputs:
  gh_token:
    description: 'The token to use to access the GitHub API'
    required: true
  superset_link:
    description: 'The link to the superset server'
    required: true
  superset_user:
    description: 'The user to use to access the Superset API'
    required: true
  superset_password:
    description: 'The password to use to access the Superset API'
    required: true

runs:
  using: 'composite'
  steps:
    - uses: actions/checkout@master
    - name: Download superset export
      shell: bash
      run: |
        NOW=$(date +%Y%m%d%H%M%S)
        mkdir -p ./superset/backups        
        LOGIN=$(curl -X POST -d '{"username": "{{ inputs.superset_user }}", "password": "{{ inputs.superset_password }}"}' -H "Content-Type: application/json" ${{ inputs.superset_link }}/api/v1/security/login)
        access_token=$(echo $LOGIN | sed "s/{.*\"access_token\":\"\([^\"]*\).*}/\1/g") 
        CSRF=$(curl --location GET "${{ inputs.superset_link }}/api/v1/security/csrf_token/" --header "Authorization: Bearer $access_token") 
        csrf_token=$(echo $CSRF | sed "s/{.*\"result\":\"\([^\"]*\).*}/\1/g") 
        curl -X GET -0 ${{ inputs.superset_link }}/api/v1/assets/export/ -H "Authorization: Bearer $access_token" -H "X-CSRFToken: $csrf_token" -o ./superset/backups/$NOW.zip
    - name: Upload superset export
      uses: actions-js/push@master
      with:
        github_token: ${{ inputs.gh_token }}
        message: 'chore: autobackup'

